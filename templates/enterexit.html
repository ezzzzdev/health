<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Re:Spring í”¼íŠ¸ë‹ˆìŠ¤ ì¶œì… í”„ë¡œê·¸ë¨-Recognize</title>
    <link rel="stylesheet" type="text/css" href="/static/css/common.css">
    <style>
        #attendBox{
            text-align: center;
            margin-top: 20px;
        }

        #attendBox .attend_enterBtn, .attend_exitBtn, .back{
            margin: 0 20px 0 20px;
            padding: 10px 20px;
            color : #03430c;
            background-color : #ffffff;
            border : solid 1px #03430c;
            text-align: center;
        }

        #attendBox .attend_enterBtn:hover, .attend_exitBtn:hover, .back:hover{
            text-shadow: 0 0 0 #ffffff;
            background-color : #03430c;
            color : #ffffff;
        }

        .commentText{
            text-align: center;
        }
    </style>
  </head>
  <body>
    <div id="mainBox">
        <a href="/" class="main_title">Re:Spring í”¼íŠ¸ë‹ˆìŠ¤ ğŸŒ·</a>
        <p class="sub_title">íšŒì› ì„¼í„° ì¶œì…</p>
    </div>
    <div id="video_container">
        <video id="webcam" autoplay muted="muted"></video><br>
    </div>
    <div id="attendBox">
        <button class="attend_enterBtn" id="enterButton">ì„¼í„° ì…ì‹¤</button>
        <button class="attend_exitBtn" id="exitButton">ì„¼í„° í‡´ì‹¤</button>
        <a class="back" href="/">ëŒì•„ê°€ê¸°</a>
    </div>
    <p id="comment" class="commentText"></p>

    <script>
      const videoElement = document.getElementById("webcam");
      const comment = document.getElementById("comment");
      let isProcessingFrame = false;
      const enterButton = document.getElementById("enterButton");
      const exitButton = document.getElementById("exitButton");
      // ì „ì—­ ë³€ìˆ˜ë¡œ ì¸í„°ë²Œ ID ì €ì¥
      let faceRecognitionIntervalId = null;

      // ì›¹ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          videoElement.srcObject = stream;
          videoElement.play();
          // startFaceRecognition();
        })
        .catch((error) => {
          console.error("Error accessing webcam:", error);
          alert(
            "ì›¹ìº ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›¹ìº  ê¶Œí•œê³¼ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
        });

      enterButton.addEventListener("click", () => {
        startFaceRecognition("enter");
      });
      exitButton.addEventListener("click", () => {
        startFaceRecognition("exit");
      });

      function clearFaceRecognitionInterval() {
        if (faceRecognitionIntervalId !== null) {
          clearInterval(faceRecognitionIntervalId);
          faceRecognitionIntervalId = null;
        }
      }

      function displayMessage(msg) {
        const messageElement = document.getElementById("message");
        if (!messageElement) {
          const comment = document.getElementById("comment");
          comment.id = "message";
          comment.style.color = "green"; // ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ë§
          comment.innerText = msg;
          // document.body.insertBefore(comment, document.body.firstChild); // video íƒœê·¸ ë°”ë¡œ ì•„ë˜ì— ë©”ì‹œì§€ë¥¼ í‘œì‹œ
        } else {
          messageElement.innerText = msg; // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        }
      }

      function startFaceRecognition(action) {
        clearFaceRecognitionInterval(); // ê¸°ì¡´ ì¸í„°ë²Œ ì·¨ì†Œ
        faceRecognitionIntervalId = setInterval(async () => {
          if (isProcessingFrame) return; // ì´ì „ í”„ë ˆì„ ì²˜ë¦¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
          isProcessingFrame = true;
          const canvas = document.createElement("canvas");
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
          const context = canvas.getContext("2d");
          context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

          // ìº”ë²„ìŠ¤ì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜
          canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append("image", blob, "image.jpg");
            formData.append("action", action);

            try {
              const response = await fetch("/recognize_face", {
                method: "POST",
                body: formData,
              });
              const data = await response.json();
              if (data) {
                displayMessage(data.message); // ì„œë²„ë¡œë¶€í„° ë°›ì€ ì‘ë‹µì„ ì‚¬ìš©ìì—ê²Œ alertë¡œ í‘œì‹œ
              }
            } catch (error) {
              console.error("Error recognizing face:", error);
            }
            isProcessingFrame = false;
          }, "image/jpeg");
        }, 3000); // 4ì´ˆ ê°„ê²©ìœ¼ë¡œ ì–¼êµ´ ì¸ì‹ ìš”ì²­
      }
    </script>
  </body>
</html>